<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduAdmin Clone - Sistema de Gestão Educacional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .sidebar{background:linear-gradient(135deg,#1e3a8a,#3b82f6);height:100vh;position:fixed;width:260px;overflow-y:auto;z-index:1000}
    .main-content{margin-left:260px;padding:20px}
    @media (max-width:768px){.sidebar{width:100%;height:auto;position:relative}.main-content{margin-left:0}}
    .card{box-shadow:0 4px 6px rgba(0,0,0,.1);border-radius:12px;overflow:hidden}
    .btn-primary{background-color:#1d4ed8;color:#fff;padding:10px 16px;border-radius:10px}
    .btn-primary:hover{background-color:#1e40af}
    .btn-ghost{padding:6px 10px;border-radius:8px}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.4)}
    .modal-content{background:#fff;margin:5% auto;padding:20px;border:1px solid #e5e7eb;width:92%;max-width:900px;border-radius:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:left}
    th{background:#f8fafc}
    .tabs button{background:none;border:none;padding:8px 12px;font-weight:600;color:#3b82f6;border-radius:10px}
    .tabs button.active{background:#e0e7ff}
    .subtabs button{background:none;border:none;padding:6px 10px;font-weight:600;color:#10b981;border-radius:10px}
    .subtabs button.active{background:#ecfdf5}
    /* Pie estilo iOS */
    .pie-wrap{display:flex;align-items:center;gap:16px}
    .pie{
      width:180px;height:180px;border-radius:50%;
      background:conic-gradient(#10b981 0 0%, #e5e7eb 0 100%);
      position:relative;box-shadow:inset 0 0 0 8px #fff, 0 10px 30px rgba(0,0,0,.05);
    }
    .pie::after{
      content:"";position:absolute;inset:12px;border-radius:50%;
      background:#ffffffcc;backdrop-filter:blur(2px);
    }
    .legend-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:8px}
    .file-pill{display:inline-flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid #e2e8f0;padding:6px 10px;border-radius:999px}
  </style>
</head>
<body class="font-sans bg-gray-100">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="p-4 text-white">
      <div class="flex items-center gap-3">
        <img id="brand-logo" src="/mnt/data/ADE94F03-419B-4132-843D-9F13BBD581A7.PNG" alt="Logo da escola" class="w-10 h-10 object-contain bg-white/10 rounded"/>
        <h2 class="text-xl font-bold">EduAdmin</h2>
      </div>
      <nav class="mt-4">
        <a href="#dashboard" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="dashboard">Dashboard</a>
        <a href="#alunos" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="alunos">Alunos</a>
        <a href="#professores" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="professores">Professores</a>
        <a href="#matriculas" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="matriculas">Matrículas</a>
        <a href="#notas" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="notas">Notas e Frequência</a>
        <a href="#relatorios" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="relatorios">Relatórios</a>
        <a href="#financeiro" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="financeiro">Financeiro</a>
        <a href="#configuracoes" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="configuracoes">Configurações</a>
        <a href="#relatorio-fin" class="block py-2 px-3 hover:bg-blue-700 rounded mb-1 nav-link" data-target="relatorio-fin">Relatório Financeiro</a>
      </nav>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main-content">
    <!-- DASHBOARD -->
    <section id="dashboard" class="section">
      <h1 class="text-2xl font-bold mb-6">Dashboard</h1>

      <!-- KPIs principais -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="card bg-white p-4"><div class="text-sm text-gray-500">Total de alunos <span class="font-medium">ativos</span></div><div id="kpialunos" class="text-3xl font-extrabold text-blue-600">0</div></div>
        <div class="card bg-white p-4"><div class="text-sm text-gray-500">Mensalidade média (R$)</div><div id="kpimediavalor" class="text-3xl font-extrabold text-emerald-600">0,00</div></div>
        <div class="card bg-white p-4"><div class="text-sm text-gray-500">Professores cadastrados</div><div id="kpiProfs" class="text-3xl font-extrabold text-purple-600">0</div></div>
        <div class="card bg-white p-4"><div class="text-sm text-gray-500">Turmas</div><div id="kpiTurmas" class="text-3xl font-extrabold text-amber-600">0</div></div>
      </div>

      <!-- Financeiro (Resumo) + Pizza Pago x Pendente -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="card bg-white p-4">
          <h3 class="text-lg font-semibold mb-3">Resumo Financeiro (mês)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="bg-slate-50 rounded-xl p-3">
              <div class="text-xs text-gray-500 mb-1">Total a receber</div>
              <div id="finReceber" class="text-2xl font-extrabold text-slate-800">R$ 0,00</div>
            </div>
            <div class="bg-emerald-50 rounded-xl p-3">
              <div class="text-xs text-gray-500 mb-1">Total pago</div>
              <div id="finPago" class="text-2xl font-extrabold text-emerald-700">R$ 0,00</div>
            </div>
            <div class="bg-amber-50 rounded-xl p-3">
              <div class="text-xs text-gray-500 mb-1">Pendente</div>
              <div id="finPendente" class="text-2xl font-extrabold text-amber-700">R$ 0,00</div>
            </div>
          </div>
        </div>

        <div class="card bg-white p-4">
          <h3 class="text-lg font-semibold mb-3">Pago x Pendente (CSS)</h3>
          <div class="pie-wrap">
            <div id="pie-finance" class="pie" aria-label="Gráfico de pizza: pago x pendente"></div>
            <div>
              <div class="mb-2"><span class="legend-dot" style="background:#10b981"></span>Pago: <span id="legendPago">0%</span></div>
              <div><span class="legend-dot" style="background:#e5e7eb"></span>Pendente: <span id="legendPend">0%</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pizzas por Idioma e por Professor -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="card bg-white p-4">
          <h3 class="text-lg font-semibold mb-3">Alunos por Idioma</h3>
          <div class="pie-wrap">
            <div id="pie-idiomas" class="pie"></div>
            <div id="legend-idiomas" class="text-sm"></div>
          </div>
        </div>
        <div class="card bg-white p-4">
          <h3 class="text-lg font-semibold mb-3">Alunos por Professor</h3>
          <div class="pie-wrap">
            <div id="pie-profs" class="pie"></div>
            <div id="legend-profs" class="text-sm"></div>
          </div>
        </div>
      </div>

      <div class="card bg-white p-4">
        <h3 class="text-lg font-semibold mb-2">Notificações Recentes</h3>
        <ul class="list-disc ml-6 text-gray-600" id="notif">
          <li>Bem-vindo! Cadastre alunos em <strong>Alunos → Adicionar</strong>.</li>
          <li>Este painel mostra o <strong>total ativo</strong> independente do idioma.</li>
        </ul>
      </div>
    </section>

    <!-- ALUNOS -->
    <section id="alunos" class="section hidden">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold">Alunos</h1>
        <div class="flex gap-2">
          <button id="btnDedupe" class="bg-amber-600 text-white px-3 py-2 rounded">Remover Duplicados</button>
          <button class="btn-primary" onclick="openModal()">Adicionar Aluno</button>
        </div>
      </div>

      <div class="card bg-white p-4 mb-6">
        <h2 class="text-lg font-semibold mb-2">Todos os alunos matriculados</h2>
        <div class="flex flex-wrap gap-2 mb-3">
          <input id="searchGlobal" class="border p-2 rounded w-full md:w-80" placeholder="Buscar por nome, CPF, email..."/>
          <select id="filterStatus" class="border p-2 rounded">
            <option value="">Todos os status</option><option>Ativo</option><option>Pendente</option><option>Trancado</option>
          </select>
          <select id="filterLang" class="border p-2 rounded">
            <option value="">Todos os idiomas</option>
            <option value="frances">Francês</option><option value="ingles">Inglês</option>
            <option value="espanhol">Espanhol</option><option value="italiano">Italiano</option><option value="alema">Alemão</option>
          </select>
        </div>
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Nome</th><th>CPF</th><th>E-mail</th><th>Contato</th>
                <th>Idioma</th><th>Turma</th><th>Professor</th><th>Valor(R$)</th><th>Status</th><th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbl-global"></tbody>
          </table>
        </div>
      </div>

      <div class="card bg-white p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Por idioma</h2>
          <div class="text-xs text-gray-500">Subcategorias por idioma e modalidade</div>
        </div>
        <div class="tabs flex flex-wrap gap-2 mb-3">
          <button class="tab-idioma active" data-lang="frances">Francês</button>
          <button class="tab-idioma" data-lang="ingles">Inglês</button>
          <button class="tab-idioma" data-lang="espanhol">Espanhol</button>
          <button class="tab-idioma" data-lang="italiano">Italiano</button>
          <button class="tab-idioma" data-lang="alema">Alemão</button>
        </div>
        <div id="lang-panels"><!-- criado via JS --></div>
      </div>
    </section>

    <!-- PROFESSORES -->
    <section id="professores" class="section hidden">
      <h1 class="text-2xl font-bold mb-4">Professores</h1>
      <div class="card bg-white p-4 mb-4">
        <div class="flex items-center gap-2">
          <button id="btnAddProf" class="btn-primary">Adicionar Professor</button>
          <button id="btnOpenPayments" class="bg-purple-600 text-white px-3 py-2 rounded">Conectar Pagamentos</button>
        </div>
      </div>
      <div class="card bg-white p-4">
        <div class="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Nome</th><th>Email</th><th>Telefone</th><th>CNPJ MEI</th><th>Idiomas</th><th>Alunos</th><th>Contrato</th><th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbl-profs"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MATRÍCULAS -->
    <section id="matriculas" class="section hidden">
      <h1 class="text-2xl font-bold mb-4">Matrículas</h1>
      <div class="card bg-white p-4 mb-3 flex items-center gap-2">
        <button id="btnNovaMatricula" class="btn-primary">Nova Matrícula</button>
        <button id="btnSyncNow" class="bg-emerald-600 text-white px-3 py-2 rounded">Sincronizar agora</button>
        <span id="syncStatus" class="text-xs text-gray-600 ml-2"></span>
      </div>
      <div class="card bg-white p-4">
        <table>
          <thead><tr><th>Aluno</th><th>Data</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody id="matriculas-list"></tbody>
        </table>
      </div>
    </section>

    <!-- NOTAS E FREQUÊNCIA -->
    <section id="notas" class="section hidden">
      <h1 class="text-2xl font-bold mb-4">Notas e Frequência</h1>
      <div class="card bg-white p-4">
        <form class="mb-4 flex flex-wrap gap-2">
          <select class="border p-2"><option>Selecionar Turma</option><option>7ª Série</option><option>8ª Série</option></select>
          <select class="border p-2"><option>Selecionar Aluno</option><option>Maria Oliveira</option><option>Pedro Santos</option></select>
          <button class="btn-primary" type="button">Filtrar</button>
        </form>
        <table><thead><tr><th>Aluno</th><th>Disciplina</th><th>Nota</th><th>Frequência</th></tr></thead>
          <tbody><tr><td>Maria Oliveira</td><td>Matemática</td><td>9.5</td><td>95%</td></tr>
          <tr><td>Pedro Santos</td><td>História</td><td>8.0</td><td>88%</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- RELATÓRIOS (genéricos) -->
    <section id="relatorios" class="section hidden">
      <h1 class="text-2xl font-bold mb-6">Relatórios</h1>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card bg-white p-4"><h3 class="text-lg font-semibold">Relatório de Notas</h3><p>Gere relatórios detalhados de desempenho por turma ou aluno.</p><a href="#" class="btn-primary mt-4 inline-block">Gerar</a></div>
        <div class="card bg-white p-4"><h3 class="text-lg font-semibold">Relatório de Frequência</h3><p>Analise a frequência geral e por período.</p><a href="#" class="btn-primary mt-4 inline-block">Gerar</a></div>
      </div>
    </section>

    <!-- FINANCEIRO -->
    <section id="financeiro" class="section hidden">
      <h1 class="text-2xl font-bold mb-4">Financeiro</h1>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="card bg-white p-4"><h3 class="text-lg font-semibold">Mensalidades (soma valores)</h3><p>Total: R$ <span id="finTotal">0</span></p></div>
        <div class="card bg-white p-4"><h3 class="text-lg font-semibold">Pendências</h3><p id="finPendencias">R$ 0,00</p></div>
        <div class="card bg-white p-4"><h3 class="text-lg font-semibold">Pagos</h3><p id="finPagos">R$ 0,00</p></div>
      </div>
      <div class="card bg-white p-4">
        <h3 class="text-lg font-semibold mb-2">Importar pagamentos (CSV)</h3>
        <p class="text-sm text-gray-600 mb-2">Formato: <code>email,valor</code> — cada linha um pagamento efetuado no mês. Isso marcará o aluno como <em>quitado</em>.</p>
        <input type="file" id="csvPayments" accept=".csv" />
        <button id="btnImportCSV" class="btn-primary ml-2">Importar</button>
        <button id="btnClearPaid" class="bg-amber-600 text-white px-3 py-2 rounded ml-2">Limpar pagos do mês</button>
      </div>
    </section>

    <!-- RELATÓRIO FINANCEIRO -->
    <section id="relatorio-fin" class="section hidden">
      <h1 class="text-2xl font-bold mb-4">Relatório Financeiro</h1>
      <div class="card bg-white p-4 mb-4">
        <div class="flex flex-wrap items-end gap-3">
          <div><label class="block text-sm mb-1">Mês</label><input type="month" id="rf-mes" class="border p-2 rounded"/></div>
          <button id="rf-gerar" class="btn-primary">Gerar Relatório</button>
          <a id="rf-download" class="hidden bg-emerald-600 text-white px-3 py-2 rounded" download="relatorio-financeiro.csv">Baixar CSV</a>
        </div>
      </div>
      <div class="card bg-white p-4">
        <h3 class="text-lg font-semibold mb-2">Resumo</h3>
        <div id="rf-resumo" class="text-sm text-gray-700"></div>
        <h3 class="text-lg font-semibold mt-4 mb-2">Devedores</h3>
        <div class="overflow-x-auto">
          <table>
            <thead><tr><th>Aluno</th><th>Email</th><th>Professor</th><th>Valor (R$)</th></tr></thead>
            <tbody id="rf-devedores"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CONFIGURAÇÕES -->
    <section id="configuracoes" class="section hidden">
      <h1 class="text-2xl font-bold mb-4">Configurações</h1>

      <!-- Marca -->
      <div class="card bg-white p-4 mb-4">
        <h3 class="text-lg font-semibold mb-2">Marca</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">URL da Logo</label>
            <input id="brand-logo-url" type="text" class="border p-2 w-full" placeholder="Cole uma URL de imagem" />
            <button id="btnSaveBrand" class="btn-primary mt-2">Salvar Marca</button>
            <p class="text-xs text-gray-500 mt-1">A logo inicial usa o arquivo fornecido, mas você pode trocar por uma URL.</p>
          </div>

          <!-- Integração externa -->
          <div>
            <h4 class="font-semibold mb-2">Integração (Leadlovers → Matrículas)</h4>
            <label class="block text-sm mb-1">Endpoint (GET JSON)</label>
            <input id="ext-pull-url" type="url" class="border p-2 w-full" placeholder="https://seu-endpoint.com/matriculas.json" />
            <label class="block text-sm mt-2 mb-1">API Key (opcional)</label>
            <input id="ext-api-key" type="text" class="border p-2 w-full" placeholder="Chave de autenticação, se houver" />
            <label class="block text-sm mt-2 mb-1">Intervalo de sincronização (segundos)</label>
            <input id="ext-polling" type="number" min="10" class="border p-2 w-40" value="30" />
            <div class="mt-2 flex gap-2">
              <button id="btnSaveExt" class="btn-primary">Salvar integração</button>
              <button id="btnTestExt" class="bg-emerald-600 text-white px-3 rounded">Testar agora</button>
            </div>
            <p class="text-xs text-gray-500 mt-1">O endpoint deve retornar <code>{ alunos: [...], matriculas: [...] }</code>.</p>
          </div>
        </div>
      </div>

      <!-- Pagamentos -->
      <div id="payments-card" class="card bg-white p-4">
        <h3 class="text-lg font-semibold mb-2">Conexões de Pagamento</h3>
        <p class="text-sm text-gray-600 mb-3">Mock seguro local: armazena os tokens localmente só para teste/visualização.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="border rounded-lg p-3">
            <h4 class="font-semibold">Mercado Pago</h4>
            <p class="text-xs text-gray-500 mb-2">Cole o token de acesso (PAT ou OAuth) para simular a integração.</p>
            <input id="mp-token" type="password" class="border p-2 w-full" placeholder="ACCESS_TOKEN..." />
            <div class="mt-2 flex gap-2">
              <button id="btnSaveMP" class="btn-primary">Conectar</button>
              <button id="btnClearMP" class="bg-gray-500 text-white px-3 rounded">Desconectar</button>
            </div>
            <div class="text-xs mt-2">Status: <span id="mp-status" class="font-semibold">Desconectado</span></div>
          </div>
          <div class="border rounded-lg p-3">
            <h4 class="font-semibold">Cora</h4>
            <p class="text-xs text-gray-500 mb-2">Cole a API Key para simular recebimentos via PIX/boletos.</p>
            <input id="cora-token" type="password" class="border p-2 w-full" placeholder="API_KEY..." />
            <div class="mt-2 flex gap-2">
              <button id="btnSaveCora" class="btn-primary">Conectar</button>
              <button id="btnClearCora" class="bg-gray-500 text-white px-3 rounded">Desconectar</button>
            </div>
            <div class="text-xs mt-2">Status: <span id="cora-status" class="font-semibold">Desconectado</span></div>
          </div>
        </div>
      </div>
    </section>

    <!-- MODAIS -->

    <!-- MODAL: ADICIONAR ALUNO -->
    <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <div class="modal-content">
        <h2 id="modal-title" class="text-xl font-bold mb-3">Adicionar Aluno</h2>
        <form id="add-form">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm mb-1">Nome completo</label><input type="text" required class="border p-2 w-full" id="aluno-nome" placeholder="Ex.: Maria Oliveira" /></div>
            <div><label class="block text-sm mb-1">CPF</label><input type="text" class="border p-2 w-full" id="aluno-cpf" placeholder="000.000.000-00" /></div>
            <div><label class="block text-sm mb-1">E-mail</label><input type="email" class="border p-2 w-full" id="aluno-email" placeholder="email@dominio.com" /></div>
            <div><label class="block text-sm mb-1">Contato (WhatsApp)</label><input type="tel" class="border p-2 w-full" id="aluno-contato" placeholder="(00) 00000-0000" /></div>
            <div><label class="block text-sm mb-1">Idioma</label><select id="aluno-idioma" class="border p-2 w-full" required><option value="frances">Francês</option><option value="ingles">Inglês</option><option value="espanhol">Espanhol</option><option value="italiano">Italiano</option><option value="alema">Alemão</option></select></div>
            <div><label class="block text-sm mb-1">Modalidade</label><select id="aluno-modalidade" class="border p-2 w-full" required><option value="turma">Turma</option><option value="individuais">Aula Individual</option><option value="duplas">Aula em Dupla</option></select></div>
            <div><label class="block text-sm mb-1">Turma / Nível</label><input type="text" class="border p-2 w-full" id="aluno-turma" placeholder="Ex.: A2 Noite / B1.2" /></div>
            <div><label class="block text-sm mb-1">Professor</label><select id="aluno-professor" class="border p-2 w-full"></select></div>
            <div><label class="block text-sm mb-1">Valor mensal (R$)</label><input type="number" step="0.01" min="0" class="border p-2 w-full" id="aluno-valor" placeholder="129.90" required /></div>
            <div><label class="block text-sm mb-1">Vencimento (dia)</label><input type="number" min="1" max="31" class="border p-2 w-full" id="aluno-vencimento" placeholder="10" /></div>
            <div><label class="block text-sm mb-1">Forma de pagamento</label><select id="aluno-pagamento" class="border p-2 w-full"><option>Pix</option><option>Cartão</option><option>Boleto</option><option>Transferência</option></select></div>
            <div><label class="block text-sm mb-1">Status</label><select id="aluno-status" class="border p-2 w-full"><option selected>Ativo</option><option>Pendente</option><option>Trancado</option></select></div>
            <div class="md:col-span-3"><label class="block text-sm mb-1">Observações</label><textarea id="aluno-obs" class="border p-2 w-full" rows="2"></textarea></div>
            <div class="md:col-span-3 flex items-center gap-2">
              <input id="aluno-quitado" type="checkbox" class="h-4 w-4"><label for="aluno-quitado" class="text-sm">Pago este mês</label>
            </div>
          </div>
          <div class="mt-4 flex gap-2"><button type="submit" class="btn-primary">Salvar</button><button type="button" onclick="closeModal()" class="bg-gray-500 text-white px-3 rounded">Cancelar</button></div>
        </form>
      </div>
    </div>

    <!-- MODAL: NOVA MATRÍCULA -->
    <div id="modal-matricula" class="modal" role="dialog" aria-modal="true" aria-labelledby="mat-title">
      <div class="modal-content">
        <h2 id="mat-title" class="text-xl font-bold mb-3">Nova Matrícula</h2>
        <form id="form-matricula">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div class="md:col-span-2">
              <label class="block text-sm mb-1">Aluno</label>
              <select id="mat-aluno" class="border p-2 w-full" required></select>
            </div>
            <div>
              <label class="block text-sm mb-1">Data</label>
              <input id="mat-data" type="date" class="border p-2 w-full" required />
            </div>
            <div>
              <label class="block text-sm mb-1">Status</label>
              <select id="mat-status" class="border p-2 w-full">
                <option value="Ativa">Ativa</option>
                <option value="Pendente">Pendente</option>
                <option value="Cancelada">Cancelada</option>
              </select>
            </div>
            <div class="md:col-span-3">
              <label class="block text-sm mb-1">Observações</label>
              <textarea id="mat-obs" class="border p-2 w-full" rows="2"></textarea>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button type="submit" class="btn-primary">Salvar</button>
            <button type="button" onclick="closeMatriculaModal()" class="bg-gray-500 text-white px-3 rounded">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL: EDITAR ALUNO -->
    <div id="modal-edit" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-title">
      <div class="modal-content">
        <h2 id="edit-title" class="text-xl font-bold mb-3">Editar Aluno</h2>
        <form id="edit-form">
          <input type="hidden" id="edit-id" />
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm mb-1">Nome completo</label><input type="text" required class="border p-2 w-full" id="edit-nome" /></div>
            <div><label class="block text-sm mb-1">CPF</label><input type="text" class="border p-2 w-full" id="edit-cpf" /></div>
            <div><label class="block text-sm mb-1">E-mail</label><input type="email" class="border p-2 w-full" id="edit-email" /></div>
            <div><label class="block text-sm mb-1">Contato</label><input type="tel" class="border p-2 w-full" id="edit-contato" /></div>
            <div><label class="block text-sm mb-1">Idioma</label>
              <select id="edit-idioma" class="border p-2 w-full">
                <option value="frances">Francês</option><option value="ingles">Inglês</option>
                <option value="espanhol">Espanhol</option><option value="italiano">Italiano</option><option value="alema">Alemão</option>
              </select>
            </div>
            <div><label class="block text-sm mb-1">Modalidade</label>
              <select id="edit-modalidade" class="border p-2 w-full">
                <option value="turma">Turma</option><option value="individuais">Individual</option><option value="duplas">Dupla</option>
              </select>
            </div>
            <div><label class="block text-sm mb-1">Turma/Nível</label><input type="text" class="border p-2 w-full" id="edit-turma" /></div>
            <div><label class="block text-sm mb-1">Professor</label>
              <select id="edit-professor" class="border p-2 w-full"></select>
            </div>
            <div><label class="block text-sm mb-1">Valor mensal (R$)</label><input type="number" step="0.01" min="0" class="border p-2 w-full" id="edit-valor" /></div>
            <div><label class="block text-sm mb-1">Vencimento (dia)</label><input type="number" min="1" max="31" class="border p-2 w-full" id="edit-vencimento" /></div>
            <div><label class="block text-sm mb-1">Forma de pagamento</label>
              <select id="edit-pagamento" class="border p-2 w-full"><option>Pix</option><option>Cartão</option><option>Boleto</option><option>Transferência</option></select>
            </div>
            <div><label class="block text-sm mb-1">Status</label>
              <select id="edit-status" class="border p-2 w-full"><option>Ativo</option><option>Pendente</option><option>Trancado</option></select>
            </div>
            <div class="md:col-span-3"><label class="block text-sm mb-1">Observações</label><textarea id="edit-obs" class="border p-2 w-full" rows="2"></textarea></div>
            <div class="md:col-span-3 flex items-center gap-2">
              <input id="edit-quitado" type="checkbox" class="h-4 w-4"><label for="edit-quitado" class="text-sm">Pago este mês</label>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button type="submit" class="btn-primary">Salvar alterações</button>
            <button type="button" onclick="closeEditModal()" class="bg-gray-500 text-white px-3 rounded">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL: ADD/EDIT PROFESSOR -->
    <div id="modal-prof" class="modal" role="dialog" aria-modal="true" aria-labelledby="prof-title">
      <div class="modal-content">
        <h2 id="prof-title" class="text-xl font-bold mb-3">Professor</h2>
        <form id="prof-form">
          <input type="hidden" id="prof-id" />
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div><label class="block text-sm mb-1">Nome</label><input id="prof-nome" type="text" class="border p-2 w-full" required /></div>
            <div><label class="block text-sm mb-1">Email</label><input id="prof-email" type="email" class="border p-2 w-full" /></div>
            <div><label class="block text-sm mb-1">Telefone</label><input id="prof-tel" type="tel" class="border p-2 w-full" /></div>
            <div><label class="block text-sm mb-1">CNPJ MEI</label><input id="prof-cnpj" type="text" class="border p-2 w-full" placeholder="00.000.000/0001-00" /></div>
            <div class="md:col-span-2"><label class="block text-sm mb-1">Idiomas (separados por vírgula)</label><input id="prof-idiomas" type="text" class="border p-2 w-full" placeholder="Inglês, Francês..." /></div>
            <div class="md:col-span-3">
              <label class="block text-sm mb-1">Contrato (upload)</label>
              <input id="prof-contrato-file" type="file" class="border p-2 w-full" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg"/>
              <div id="prof-contrato-info" class="mt-2 text-sm text-gray-700"></div>
            </div>
          </div>
          <div class="mt-4 flex gap-2">
            <button type="submit" class="btn-primary">Salvar</button>
            <button type="button" id="prof-cancel" class="bg-gray-500 text-white px-3 rounded">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- RESULTADOS DE TESTES -->
    <div id="test-results" class="hidden fixed bottom-4 right-4 w-96 bg-white border border-gray-200 shadow-lg rounded-lg p-4 text-sm"></div>
  </main>

  <!-- JS -->
  <script>
  (function(){
    function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded',fn); }

    onReady(function(){
      /**********************
       * Navegação
       **********************/
      const sections = document.querySelectorAll('.section');
      document.querySelectorAll('.nav-link').forEach(a=>{
        a.addEventListener('click',e=>{
          e.preventDefault();
          const id=e.currentTarget.getAttribute('data-target');
          sections.forEach(s=>s.classList.add('hidden'));
          const el=document.getElementById(id);
          if(el) el.classList.remove('hidden');
        });
      });

      /**********************
       * Storage & Constantes
       **********************/
      const STORAGE_KEY='eduadmin_alunos_v3';
      const MATRICULAS_KEY='eduadmin_matriculas_v1';
      const BRAND_KEY='eduadmin_brand_v1';
      const EXT_KEY='eduadmin_ext_cfg_v1';
      const PROFS_KEY='eduadmin_profs_v1';
      const PAY_KEY='eduadmin_pay_v1';

      const loadAlunos=()=>JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
      const saveAlunos=(arr)=>localStorage.setItem(STORAGE_KEY,JSON.stringify(arr));
      const loadMatriculas=()=>JSON.parse(localStorage.getItem(MATRICULAS_KEY)||'[]');
      const saveMatriculas=(arr)=>localStorage.setItem(MATRICULAS_KEY,JSON.stringify(arr));
      const loadProfs=()=>JSON.parse(localStorage.getItem(PROFS_KEY)||'[]');
      const saveProfs=(arr)=>localStorage.setItem(PROFS_KEY,JSON.stringify(arr));
      const loadPay=()=>JSON.parse(localStorage.getItem(PAY_KEY)||'{}');
      const savePay=(o)=>localStorage.setItem(PAY_KEY,JSON.stringify(o||{}));

      const LANG_LABEL={frances:'Francês', ingles:'Inglês', espanhol:'Espanhol', italiano:'Italiano', alema:'Alemão'};
      const LANGS=['frances','ingles','espanhol','italiano','alema'];
      const MODS=['turma','individuais','duplas'];
      const PIE_COLORS=['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16','#f472b6','#a3e635','#22c55e'];

      /**********************
       * Marca
       **********************/
      const brand = JSON.parse(localStorage.getItem(BRAND_KEY)||'{}');
      const logoEl=document.getElementById('brand-logo');
      if(brand.logo){ logoEl.src=brand.logo; }
      document.getElementById('btnSaveBrand')?.addEventListener('click',()=>{
        const url=document.getElementById('brand-logo-url').value.trim();
        if(url){localStorage.setItem(BRAND_KEY,JSON.stringify({logo:url}));logoEl.src=url;alert('Logo atualizada!');}
      });

      /**********************
       * Integração externa (GET JSON)
       **********************/
      let EXT = JSON.parse(localStorage.getItem(EXT_KEY) || '{"pullUrl":"","apiKey":"","pollingMs":30000}');
      const syncStatusEl = document.getElementById('syncStatus');
      function saveExtCfg(){ localStorage.setItem(EXT_KEY, JSON.stringify(EXT)); }
      function setSyncStatus(msg){ if(syncStatusEl){ syncStatusEl.textContent = msg; } }
      const extUrlIn = document.getElementById('ext-pull-url');
      const extApiKeyIn = document.getElementById('ext-api-key');
      const extPollingIn = document.getElementById('ext-polling');
      if(extUrlIn) extUrlIn.value = EXT.pullUrl || '';
      if(extApiKeyIn) extApiKeyIn.value = EXT.apiKey || '';
      if(extPollingIn) extPollingIn.value = (EXT.pollingMs||30000)/1000;
      const DEFAULT_EXT_URL = 'https://script.google.com/macros/s/AKfycbxGLRVKXfjooejp9-s7mR8SeOMNwsKc6gJi7WDBTYjTWOcpAn-1hxi3htNjopXovFMm/exec';
      if(!EXT.pullUrl){
        EXT.pullUrl = DEFAULT_EXT_URL;
        saveExtCfg();
        if(extUrlIn) extUrlIn.value = EXT.pullUrl;
        setSyncStatus('Endpoint configurado');
      }
      document.getElementById('btnSaveExt')?.addEventListener('click', ()=>{
        EXT.pullUrl = (extUrlIn?.value||'').trim();
        EXT.apiKey = (extApiKeyIn?.value||'').trim();
        EXT.pollingMs = Math.max(10, parseInt(extPollingIn?.value||'30'))*1000;
        saveExtCfg();
        alert('Integração salva.');
      });
      document.getElementById('btnTestExt')?.addEventListener('click', ()=>pullOnce());
      document.getElementById('btnSyncNow')?.addEventListener('click', ()=>pullOnce());

      /**********************
       * Helpers de normalização
       **********************/
      const strip = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
      const mapIdioma = (v)=>{
        const s = strip(v);
        if(/franc/.test(s) || /french|\bfr\b/.test(s)) return 'frances';
        if(/ingl/.test(s)  || /english|\ben\b/.test(s)) return 'ingles';
        if(/espan/.test(s) || /spanish|\bes\b/.test(s)) return 'espanhol';
        if(/ital/.test(s)  || /\bit\b/.test(s))         return 'italiano';
        if(/alem/.test(s)  || /german|\bde\b/.test(s))  return 'alema';
        return 'ingles';
      };
      const mapModalidade = (v)=>({turma:'turma',individual:'individuais',individuais:'individuais',dupla:'duplas',duplas:'duplas'}[(String(v||'').toLowerCase())] || 'turma');

      /**********************
       * Upserts
       **********************/
      function upsertAluno(raw){
        const a = {
          id: raw.id || Date.now()+Math.floor(Math.random()*1000),
          nome: raw.nome || raw.name || '',
          cpf: raw.cpf || '',
          email: (raw.email||'').toLowerCase(),
          contato: raw.contato || raw.telefone || '',
          idioma: mapIdioma(raw.idioma),
          modalidade: mapModalidade(raw.modalidade),
          turma: raw.turma || raw.nivel || '',
          professor: raw.professor || '',
          valor: parseFloat(raw.valor ?? raw.mensalidade ?? 0) || 0,
          vencimento: raw.vencimento || '',
          pagamento: raw.pagamento || '',
          status: raw.status || 'Ativo',
          obs: raw.obs || '',
          quitado: !!raw.quitado,
          ext_id: raw.ext_id || raw.external_id || null
        };
        const arr = loadAlunos();
        let idx = arr.findIndex(x => (a.cpf && x.cpf===a.cpf) || (a.email && x.email && x.email.toLowerCase()===a.email));
        if(idx === -1){ arr.push(a); }
        else { arr[idx] = {...arr[idx], ...a, id: arr[idx].id}; }
        saveAlunos(arr);
        return arr.find(x => (a.cpf && x.cpf===a.cpf) || (a.email && x.email && x.email.toLowerCase()===a.email))?.id || a.id;
      }
      function findAlunoIdFromPayload(m){
        const arr = loadAlunos();
        if(m.alunoId){ const f=arr.find(a=>String(a.id)===String(m.alunoId)); if(f) return f.id; }
        if(m.alunoCpf){ const f=arr.find(a=>a.cpf && a.cpf===m.alunoCpf); if(f) return f.id; }
        if(m.alunoEmail){ const f=arr.find(a=>a.email && a.email.toLowerCase()===String(m.alunoEmail).toLowerCase()); if(f) return f.id; }
        return null;
      }
      function upsertMatricula(raw){
        const m = {
          id: raw.id || Date.now()+Math.floor(Math.random()*1000),
          alunoId: findAlunoIdFromPayload(raw) || (raw.aluno ? upsertAluno(raw.aluno) : null),
          data: raw.data || raw.data_matricula || new Date().toISOString().slice(0,10),
          status: raw.status || 'Ativa',
          obs: raw.obs || '',
          ext_id: raw.ext_id || raw.external_id || null
        };
        const arr = loadMatriculas();
        let idx = arr.findIndex(x =>
           (m.ext_id && x.ext_id===m.ext_id) ||
           (x.alunoId===m.alunoId && x.data===m.data && x.status===m.status));
        if(idx === -1){ arr.push(m); } else { arr[idx] = {...arr[idx], ...m, id: arr[idx].id}; }
        saveMatriculas(arr);
      }

      /**********************
       * DEDUPE
       **********************/
      function normalizeCpf(v){ return String(v||'').replace(/\D/g,''); }
      function canonEmail(v){ return String(v||'').trim().toLowerCase(); }
      function canonNome(v){ return String(v||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }
      function canonTel(v){ return String(v||'').replace(/\D/g,''); }
      function keyAluno(a){
        const cpf = normalizeCpf(a.cpf);
        if(cpf) return 'CPF:'+cpf;
        const email = canonEmail(a.email);
        if(email) return 'EMAIL:'+email;
        return 'NOME:'+canonNome(a.nome)+'|TEL:'+canonTel(a.contato);
      }
      function scoreAluno(a){
        const campos = ['nome','cpf','email','contato','idioma','modalidade','turma','professor','valor','vencimento','pagamento','status','obs','ext_id','quitado'];
        return campos.reduce((s,k)=>{
          const v=a[k];
          if(v===0) return s+0.5;
          return s + (v && String(v).trim()!=='' ? 1 : 0);
        },0);
      }
      function mergeAlunoPreferindoCompleto(winner, other){
        const out = {...winner};
        const fields = ['nome','cpf','email','contato','idioma','modalidade','turma','professor','valor','vencimento','pagamento','status','obs','ext_id','quitado'];
        for(const f of fields){
          const cur = out[f];
          const novo = other[f];
          const vazio = (cur==null || cur==='' || cur===0);
          if(vazio && (novo!=null && String(novo)!=='')) out[f] = f==='valor' ? Number(novo)||0 : novo;
          if(f==='quitado') out.quitado = !!(winner.quitado || other.quitado);
        }
        return out;
      }
      function dedupeAlunos(){
        const alunos = loadAlunos();
        const mats   = loadMatriculas();
        const map = new Map();
        const idMap = new Map();
        let removidos=0, mesclados=0;
        for(const a of alunos){
          const k = keyAluno(a);
          if(!map.has(k)){ map.set(k, {...a}); }
          else{
            const cur = map.get(k);
            const sCur=scoreAluno(cur), sA=scoreAluno(a);
            let winner = cur, loser=a;
            if(sA > sCur || (sA===sCur && Number(a.id)>Number(cur.id))){
              winner=a; loser=cur;
            }
            const merged = mergeAlunoPreferindoCompleto(winner, loser);
            map.set(k, merged);
            idMap.set(String(loser.id), String(merged.id));
            removidos++; mesclados++;
          }
        }
        const dedupedAlunos = Array.from(map.values());
        let remappedMats = mats.map(m=>{
          const novoId = idMap.get(String(m.alunoId));
          return novoId ? {...m, alunoId: novoId} : m;
        });
        const seen = new Set();
        const dedupedMats=[];
        for(const m of remappedMats){
          const k = `${m.alunoId}|${m.data}|${m.status}`;
          if(!seen.has(k)){ seen.add(k); dedupedMats.push(m); }
        }
        saveAlunos(dedupedAlunos);
        saveMatriculas(dedupedMats);
        return {removidos, mesclados, total: alunos.length, final: dedupedAlunos.length};
      }
      document.getElementById('btnDedupe')?.addEventListener('click', ()=>{
        const r = dedupeAlunos();
        alert(`Duplicados removidos: ${r.removidos}\nRegistros finais: ${r.final}`);
        renderAll();
      });

      /**********************
       * Pull externo
       **********************/
      async function pullOnce(){
        if(!EXT.pullUrl){ setSyncStatus('Configure o endpoint de integração.'); return; }
        setSyncStatus('Sincronizando…');
        try{
          const res = await fetch(EXT.pullUrl, { headers: EXT.apiKey ? {'X-API-Key': EXT.apiKey} : {} });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          const {alunos=[], matriculas=[]} = data||{};
          alunos.forEach(upsertAluno);
          matriculas.forEach(upsertMatricula);
          dedupeAlunos();
          renderAll();
          setSyncStatus('Atualizado às '+ new Date().toLocaleTimeString('pt-BR'));
        }catch(err){
          console.error(err);
          setSyncStatus('Erro: '+ err.message);
        }
      }
      if(EXT.pullUrl){
        pullOnce();
        setInterval(()=>pullOnce(), EXT.pollingMs||30000);
      }

      /**********************
       * Professores (CRUD + contrato)
       **********************/
      function defaultProfsIfEmpty(){
        const arr = loadProfs();
        if(arr.length) return;
        const seed = [
          {id: 1001, nome:'Prof. Elise', email:'elise@ex.com', tel:'', cnpj:'', idiomas:'Francês', contrato:null},
          {id: 1002, nome:'Prof. Maria', email:'maria@ex.com', tel:'', cnpj:'', idiomas:'Inglês', contrato:null},
          {id: 1003, nome:'Prof. Verdi', email:'verdi@ex.com', tel:'', cnpj:'', idiomas:'Italiano', contrato:null},
          {id: 1004, nome:'Prof. Wagner', email:'wagner@ex.com', tel:'', cnpj:'', idiomas:'Alemão', contrato:null},
          {id: 1005, nome:'Prof. Bianchi', email:'bianchi@ex.com', tel:'', cnpj:'', idiomas:'Italiano', contrato:null},
        ];
        saveProfs(seed);
      }
      defaultProfsIfEmpty();

      const tblProfs = document.getElementById('tbl-profs');
      function countAlunosByProf(nome){
        return loadAlunos().filter(a => (a.professor||'').trim()===nome).length;
      }
      function renderProfs(){
        const arr = loadProfs();
        tblProfs.innerHTML='';
        arr.forEach(p=>{
          const tr = document.createElement('tr');
          const contrato = p.contrato ? `<a href="${p.contrato.dataURL}" download="${p.contrato.name}" class="text-blue-600 hover:underline">Baixar</a>` : '<span class="text-gray-400">—</span>';
          tr.innerHTML = `
            <td>${p.nome||'-'}</td>
            <td>${p.email||'-'}</td>
            <td>${p.tel||'-'}</td>
            <td>${p.cnpj||'-'}</td>
            <td>${p.idiomas||'-'}</td>
            <td>${countAlunosByProf(p.nome)}</td>
            <td>${contrato}</td>
            <td class="whitespace-nowrap">
              <a href="#" class="text-blue-600 hover:underline act-edit" data-id="${p.id}">Editar</a>
              <span class="text-gray-300 mx-1">|</span>
              <a href="#" class="text-red-600 hover:underline act-del" data-id="${p.id}">Remover</a>
            </td>
          `;
          tblProfs.appendChild(tr);
        });

        // Atualiza dropdowns de professor nos modais de aluno
        const profNames = arr.map(p=>p.nome);
        const selAdd = document.getElementById('aluno-professor');
        const selEdit = document.getElementById('edit-professor');
        [selAdd, selEdit].forEach(sel=>{
          if(!sel) return;
          sel.innerHTML = '<option value="">—</option>' + profNames.map(n=>`<option>${n}</option>`).join('');
        });

        // KPI de professores
        document.getElementById('kpiProfs').textContent = String(arr.length);
      }
      renderProfs();

      // Modal professor
      const modalProf = document.getElementById('modal-prof');
      const profForm  = document.getElementById('prof-form');
      const btnAddProf = document.getElementById('btnAddProf');
      const profCancel = document.getElementById('prof-cancel');

      function openProfModal(id){
        const p = id ? loadProfs().find(x=>String(x.id)===String(id)) : null;
        document.getElementById('prof-id').value = p? p.id : '';
        document.getElementById('prof-nome').value = p? (p.nome||'') : '';
        document.getElementById('prof-email').value = p? (p.email||'') : '';
        document.getElementById('prof-tel').value = p? (p.tel||'') : '';
        document.getElementById('prof-cnpj').value = p? (p.cnpj||'') : '';
        document.getElementById('prof-idiomas').value = p? (p.idiomas||'') : '';
        const info = document.getElementById('prof-contrato-info');
        info.innerHTML = p && p.contrato
          ? `<span class="file-pill"><span>📄</span><span>${p.contrato.name}</span>
              <a href="${p.contrato.dataURL}" download="${p.contrato.name}" class="text-blue-600 underline">Baixar</a>
              <button type="button" id="btnDelContrato" class="text-red-600 underline">Remover</button></span>`
          : '<span class="text-gray-400">Nenhum contrato anexado</span>';
        modalProf.style.display='block';

        // Remover contrato
        setTimeout(()=>{ // garante que o botão exista
          const btnDel = document.getElementById('btnDelContrato');
          if(btnDel){
            btnDel.onclick = ()=>{
              const arr = loadProfs();
              const idx = arr.findIndex(x=>String(x.id)===String(id));
              if(idx>-1){ arr[idx].contrato = null; saveProfs(arr); openProfModal(id); renderProfs(); }
            };
          }
        }, 0);
      }
      function closeProfModal(){ modalProf.style.display='none'; }

      btnAddProf?.addEventListener('click', ()=>openProfModal(null));
      profCancel?.addEventListener('click', closeProfModal);

      // Salvar professor
      profForm.addEventListener('submit', async function(e){
        e.preventDefault();
        const id = document.getElementById('prof-id').value || (Date.now()+Math.floor(Math.random()*1000));
        const p = {
          id,
          nome: document.getElementById('prof-nome').value.trim(),
          email: document.getElementById('prof-email').value.trim(),
          tel: document.getElementById('prof-tel').value.trim(),
          cnpj: document.getElementById('prof-cnpj').value.trim(),
          idiomas: document.getElementById('prof-idiomas').value.trim()
        };

        // Lê arquivo de contrato se houver
        const file = document.getElementById('prof-contrato-file').files[0];
        let contrato = null;
        if(file){
          const dataURL = await new Promise(res=>{
            const fr = new FileReader();
            fr.onload = ()=>res(fr.result);
            fr.readAsDataURL(file);
          });
          contrato = { name: file.name, dataURL, uploadedAt: new Date().toISOString() };
        }

        const arr = loadProfs();
        const idx = arr.findIndex(x=>String(x.id)===String(id));
        if(idx===-1){ arr.push({...p, contrato}); }
        else{
          arr[idx] = {...arr[idx], ...p, contrato: contrato || arr[idx].contrato };
        }
        saveProfs(arr);
        closeProfModal();
        renderProfs();
        renderDashboard(); // atualiza KPI
        renderPies();      // professor pie
      });

      // Ações na tabela de professores
      tblProfs.addEventListener('click', function(e){
        const a = e.target.closest('a'); if(!a) return;
        e.preventDefault();
        const id = a.getAttribute('data-id');
        if(a.classList.contains('act-edit')) openProfModal(id);
        if(a.classList.contains('act-del')){
          if(!confirm('Remover este professor?')) return;
          const arr = loadProfs().filter(p=>String(p.id)!==String(id));
          saveProfs(arr);
          // Limpa referência nos alunos que tinham esse professor
          const alunos = loadAlunos().map(al=> (al.professor===arr.nome ? {...al, professor:''} : al));
          saveAlunos(alunos);
          renderProfs(); renderAll();
        }
      });

      // Botão rápido para abrir conexões de pagamento via Professores
      document.getElementById('btnOpenPayments')?.addEventListener('click',()=>{
        sections.forEach(s=>s.classList.add('hidden'));
        const cfg = document.getElementById('configuracoes');
        cfg.classList.remove('hidden');
        document.getElementById('payments-card').scrollIntoView({behavior:'smooth', block:'start'});
      });

      /**********************
       * Conexões Pagamento (mock)
       **********************/
      const mpTokenIn = document.getElementById('mp-token');
      const coraTokenIn = document.getElementById('cora-token');
      const mpStatus = document.getElementById('mp-status');
      const coraStatus = document.getElementById('cora-status');

      function refreshPayUI(){
        const p = loadPay();
        mpStatus.textContent = p.mpToken ? 'Conectado' : 'Desconectado';
        coraStatus.textContent = p.coraToken ? 'Conectado' : 'Desconectado';
        if(mpTokenIn) mpTokenIn.value = p.mpToken || '';
        if(coraTokenIn) coraTokenIn.value = p.coraToken || '';
      }
      refreshPayUI();

      document.getElementById('btnSaveMP')?.addEventListener('click', ()=>{
        const p = loadPay(); p.mpToken = mpTokenIn.value.trim(); savePay(p); refreshPayUI(); alert('Mercado Pago conectado (mock).');
      });
      document.getElementById('btnClearMP')?.addEventListener('click', ()=>{ const p=loadPay(); delete p.mpToken; savePay(p); refreshPayUI(); });
      document.getElementById('btnSaveCora')?.addEventListener('click', ()=>{
        const p = loadPay(); p.coraToken = coraTokenIn.value.trim(); savePay(p); refreshPayUI(); alert('Cora conectado (mock).');
      });
      document.getElementById('btnClearCora')?.addEventListener('click', ()=>{ const p=loadPay(); delete p.coraToken; savePay(p); refreshPayUI(); });

      /**********************
       * Seletores/KPI/Financeiro
       **********************/
      const tbodyGlobal=document.getElementById('tbl-global');
      const kpialunos=document.getElementById('kpialunos');
      const kpimediavalor=document.getElementById('kpimediavalor');
      const kpiProfs=document.getElementById('kpiProfs');
      const kpiTurmas=document.getElementById('kpiTurmas');
      const finTotal=document.getElementById('finTotal');
      const finReceber=document.getElementById('finReceber');
      const finPago=document.getElementById('finPago');
      const finPendente=document.getElementById('finPendente');
      const finPagos=document.getElementById('finPagos');
      const finPendencias=document.getElementById('finPendencias');
      const pieFinance=document.getElementById('pie-finance');
      const legendPago=document.getElementById('legendPago');
      const legendPend=document.getElementById('legendPend');

      document.getElementById('searchGlobal').addEventListener('input',renderGlobal);
      document.getElementById('filterStatus').addEventListener('change',renderGlobal);
      document.getElementById('filterLang').addEventListener('change',renderGlobal);

      function renderDashboard(){
        const alunos=loadAlunos();
        const ativos=alunos.filter(a=>a.status==='Ativo');
        kpialunos.textContent=String(ativos.length);
        const media = ativos.length? (ativos.reduce((s,a)=>s+(a.valor||0),0)/ativos.length):0;
        kpimediavalor.textContent=media.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});

        const profsArr = loadProfs();
        kpiProfs.textContent=String(profsArr.length);
        const turmas = new Set(alunos.map(a=>a.turma).filter(Boolean));
        kpiTurmas.textContent=String(turmas.size);

        // Financeiro
        const totalValores = alunos.reduce((s,a)=>s+(a.valor||0),0);
        finTotal.textContent = totalValores.toLocaleString('pt-BR',{minimumFractionDigits:2});
        const receber = ativos.reduce((s,a)=>s+(a.valor||0),0);
        const pago    = ativos.reduce((s,a)=>s+(a.quitado? (a.valor||0) : 0),0);
        const pend    = Math.max(0, receber - pago);
        finReceber.textContent = 'R$ '+ receber.toLocaleString('pt-BR',{minimumFractionDigits:2});
        finPago.textContent    = 'R$ '+ pago.toLocaleString('pt-BR',{minimumFractionDigits:2});
        finPendente.textContent= 'R$ '+ pend.toLocaleString('pt-BR',{minimumFractionDigits:2});
        finPagos.textContent   = 'R$ '+ pago.toLocaleString('pt-BR',{minimumFractionDigits:2});
        finPendencias.textContent = 'R$ '+ pend.toLocaleString('pt-BR',{minimumFractionDigits:2});

        // Pie CSS pago x pendente
        const pctPago = receber>0 ? Math.round((pago/receber)*100) : 0;
        const pctPend = 100 - pctPago;
        if(pieFinance){
          pieFinance.style.background = `conic-gradient(#10b981 0 ${pctPago}%, #e5e7eb ${pctPago}% 100%)`;
        }
        if(legendPago) legendPago.textContent = pctPago+'%';
        if(legendPend) legendPend.textContent = pctPend+'%';
      }

      function rowAluno(a){
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${a.nome}</td>
          <td>${a.cpf||'-'}</td>
          <td>${a.email||'-'}</td>
          <td>${a.contato||'-'}</td>
          <td>${LANG_LABEL[a.idioma]||a.idioma}</td>
          <td>${a.turma||'-'}</td>
          <td>${a.professor||'-'}</td>
          <td>${(a.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
          <td>${a.status||'-'} ${a.quitado?'<span class="text-emerald-600 text-xs ml-1">• pago</span>':''}</td>
          <td class="whitespace-nowrap">
            <a href="#" class="text-blue-600 hover:underline edit-aluno" data-id="${a.id}">Editar</a>
            <span class="text-gray-300 mx-1">|</span>
            <a href="#" class="text-red-600 hover:underline remove-aluno" data-id="${a.id}">Remover</a>
          </td>`;
        return tr;
      }

      function renderGlobal(){
        tbodyGlobal.innerHTML='';
        const q=(document.getElementById('searchGlobal').value||'').toLowerCase();
        const st=document.getElementById('filterStatus').value;
        const lg=document.getElementById('filterLang').value;
        loadAlunos().filter(a=>{
          const hit = [a.nome,a.cpf,a.email].some(v=>String(v||'').toLowerCase().includes(q));
          const okS = st? a.status===st : true;
          const okL = lg? a.idioma===lg : true;
          return hit && okS && okL;
        }).forEach(a=>tbodyGlobal.appendChild(rowAluno(a)));
      }

      /**********************
       * Tabelas por idioma (com subtabs)
       **********************/
      function ensureLangPanels(){
        const host=document.getElementById('lang-panels');
        if(host.children.length) return;
        LANGS.forEach(l=>{
          const wrap=document.createElement('div');
          wrap.id='panel-'+l; wrap.className='lang-panel';
          if(l!=='frances') wrap.classList.add('hidden');
          wrap.innerHTML=`
            <div class="subtabs flex flex-wrap gap-2 mb-3">
              <button class="subtab active" data-mod="turma">Turma</button>
              <button class="subtab" data-mod="individuais">Aulas Individuais</button>
              <button class="subtab" data-mod="duplas">Aulas em Duplas</button>
            </div>
            <div class="overflow-x-auto">
              <div id="box-${l}-turma">
                <table><thead><tr><th>Nome</th><th>Nível/Turma</th><th>Professor</th><th>Valor(R$)</th><th>Status</th></tr></thead><tbody id="tbl-${l}-turma"></tbody></table>
              </div>
              <div id="box-${l}-individuais" class="hidden">
                <table><thead><tr><th>Nome</th><th>Horário</th><th>Professor</th><th>Valor(R$)</th><th>Status</th></tr></thead><tbody id="tbl-${l}-individuais"></tbody></table>
              </div>
              <div id="box-${l}-duplas" class="hidden">
                <table><thead><tr><th>Nomes</th><th>Horário</th><th>Professor</th><th>Valor(R$)</th><th>Status</th></tr></thead><tbody id="tbl-${l}-duplas"></tbody></table>
              </div>
            </div>`;
          host.appendChild(wrap);
          wrap.querySelectorAll('.subtab').forEach(btn=>{
            btn.addEventListener('click',()=>{
              wrap.querySelectorAll('.subtab').forEach(b=>b.classList.remove('active'));
              btn.classList.add('active');
              MODS.forEach(m=>wrap.querySelector('#box-'+l+'-'+m).classList.add('hidden'));
              wrap.querySelector('#box-'+l+'-'+btn.getAttribute('data-mod')).classList.remove('hidden');
            });
          });
        });
      }
      function setupLangTabClicks(){
        const tabs = document.querySelectorAll('.tab-idioma');
        tabs.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            tabs.forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const lang = btn.getAttribute('data-lang');
            LANGS.forEach(l=>{
              const p = document.getElementById('panel-'+l);
              if(p) p.classList.add('hidden');
            });
            const active = document.getElementById('panel-'+lang);
            if(active) active.classList.remove('hidden');
          });
        });
      }
      function renderByLanguage(){
        ensureLangPanels();
        LANGS.forEach(l=>{ MODS.forEach(m=>{ const tb=document.getElementById(`tbl-${l}-${m}`); if(tb) tb.innerHTML=''; }); });
        loadAlunos().forEach(a=>{
          const tb=document.getElementById(`tbl-${a.idioma}-${a.modalidade}`);
          if(!tb) return;
          const tr=document.createElement('tr');
          if(a.modalidade==='turma') tr.innerHTML=`<td>${a.nome}</td><td>${a.turma||'-'}</td><td>${a.professor||'-'}</td><td>${(a.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>${a.status||'-'}</td>`;
          if(a.modalidade==='individuais') tr.innerHTML=`<td>${a.nome}</td><td>${a.horario||'-'}</td><td>${a.professor||'-'}</td><td>${(a.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>${a.status||'-'}</td>`;
          if(a.modalidade==='duplas') tr.innerHTML=`<td>${a.nome}</td><td>${a.horario||'-'}</td><td>${a.professor||'-'}</td><td>${(a.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>${a.status||'-'}</td>`;
          tb.appendChild(tr);
        });
      }

      /**********************
       * Pizzas (Idiomas e Professores)
       **********************/
      function buildConicGradient(parts){
        // parts: [{color, fromPct, toPct}]
        return 'conic-gradient(' + parts.map(p=>`${p.color} ${p.fromPct}% ${p.toPct}%`).join(', ') + ')';
        }
      function renderPieFromCounts(targetEl, legendEl, countsMap){
        const entries = Object.entries(countsMap).filter(([k,v])=>v>0);
        const total = entries.reduce((s, [,v])=>s+v, 0);
        if(total===0){
          targetEl.style.background = 'conic-gradient(#e5e7eb 0 100%)';
          legendEl.innerHTML = '<span class="text-gray-400">Sem dados</span>';
          return;
        }
        // sort desc
        entries.sort((a,b)=>b[1]-a[1]);
        let acc=0;
        const parts=[];
        legendEl.innerHTML='';
        entries.forEach(([label,val],i)=>{
          const from = acc/total*100;
          acc += val;
          const to = acc/total*100;
          const color = PIE_COLORS[i % PIE_COLORS.length];
          parts.push({color, fromPct: from, toPct: to});
          const row = document.createElement('div');
          row.className = 'mb-1';
          row.innerHTML = `<span class="legend-dot" style="background:${color}"></span>${label}: <strong>${val}</strong> (${Math.round(val/total*100)}%)`;
          legendEl.appendChild(row);
        });
        targetEl.style.background = buildConicGradient(parts);
      }
      function renderPies(){
        const alunos = loadAlunos();
        // Idiomas
        const byLang = {};
        alunos.forEach(a=>{
          const lbl = LANG_LABEL[a.idioma] || a.idioma || '—';
          byLang[lbl] = (byLang[lbl]||0) + 1;
        });
        renderPieFromCounts(document.getElementById('pie-idiomas'), document.getElementById('legend-idiomas'), byLang);

        // Professores
        const byProf = {};
        alunos.forEach(a=>{
          const lbl = (a.professor && a.professor.trim()) ? a.professor.trim() : 'Sem professor';
          byProf[lbl] = (byProf[lbl]||0) + 1;
        });
        renderPieFromCounts(document.getElementById('pie-profs'), document.getElementById('legend-profs'), byProf);
      }

      /**********************
       * MATRÍCULAS
       **********************/
      const btnNovaMatricula=document.getElementById('btnNovaMatricula');
      const modalMatricula=document.getElementById('modal-matricula');
      const formMatricula=document.getElementById('form-matricula');
      const listMatriculas=document.getElementById('matriculas-list');

      function openMatriculaModal(){
        const sel=document.getElementById('mat-aluno');
        sel.innerHTML='';
        const alunos=loadAlunos();
        if(!alunos.length){
          const opt=document.createElement('option');
          opt.textContent='Nenhum aluno cadastrado';
          opt.disabled=true; opt.selected=true;
          sel.appendChild(opt);
        } else {
          alunos.forEach(a=>{ const o=document.createElement('option'); o.value=String(a.id); o.textContent=a.nome; sel.appendChild(o); });
        }
        const today=new Date(); const yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
        document.getElementById('mat-data').value=`${yyyy}-${mm}-${dd}`;
        modalMatricula.style.display='block';
      }
      function closeMatriculaModal(){ modalMatricula.style.display='none'; }
      window.closeMatriculaModal=closeMatriculaModal;
      btnNovaMatricula?.addEventListener('click',openMatriculaModal);

      function renderMatriculas(){
        listMatriculas.innerHTML='';
        const arr=loadMatriculas().sort((a,b)=> new Date(b.data)-new Date(a.data));
        arr.forEach(m=>{
          const aluno = loadAlunos().find(a=>String(a.id)===String(m.alunoId));
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${aluno?aluno.nome:'(Aluno removido)'}</td><td>${new Date(m.data).toLocaleDateString('pt-BR')}</td><td>${m.status}</td><td><a href="#" class="text-blue-600" data-id="${m.id}" data-action="ver">Ver</a> | <a href="#" class="text-red-600" data-id="${m.id}" data-action="del">Excluir</a></td>`;
          listMatriculas.appendChild(tr);
        });
      }
      listMatriculas.addEventListener('click',function(e){
        const t=e.target; if(t.tagName!=='A') return; e.preventDefault();
        const id=t.getAttribute('data-id'); const action=t.getAttribute('data-action');
        if(action==='del'){
          const arr=loadMatriculas().filter(x=>String(x.id)!==String(id));
          saveMatriculas(arr); renderMatriculas();
        } else if(action==='ver'){
          alert('Detalhe simples:\nID: '+id+'\n(Expanda aqui se quiser ver mais campos)');
        }
      });
      formMatricula?.addEventListener('submit',function(e){
        e.preventDefault();
        const alunoId=document.getElementById('mat-aluno').value;
        if(!alunoId){ alert('Selecione um aluno.'); return; }
        const obj={ id:Date.now(), alunoId, data:document.getElementById('mat-data').value, status:document.getElementById('mat-status').value, obs:document.getElementById('mat-obs').value.trim() };
        const arr=loadMatriculas(); arr.push(obj); saveMatriculas(arr);
        closeMatriculaModal(); renderMatriculas();
      });

      /**********************
       * MODAIS Aluno (abrir/fechar/salvar/editar)
       **********************/
      window.openModal=function(){ 
        // popular professores na hora de adicionar
        renderProfs();
        document.getElementById('modal').style.display='block'; 
      };
      window.closeModal=function(){ document.getElementById('modal').style.display='none'; };

      const form=document.getElementById('add-form');
      form?.addEventListener('submit',e=>{
        e.preventDefault();
        const aluno={
          id:Date.now(),
          nome:document.getElementById('aluno-nome').value.trim(),
          cpf:document.getElementById('aluno-cpf').value.trim(),
          email:document.getElementById('aluno-email').value.trim(),
          contato:document.getElementById('aluno-contato').value.trim(),
          idioma:document.getElementById('aluno-idioma').value,
          modalidade:document.getElementById('aluno-modalidade').value,
          turma:document.getElementById('aluno-turma').value.trim(),
          professor:document.getElementById('aluno-professor').value,
          valor:parseFloat(document.getElementById('aluno-valor').value||'0'),
          vencimento:document.getElementById('aluno-vencimento').value,
          pagamento:document.getElementById('aluno-pagamento').value,
          status:document.getElementById('aluno-status').value,
          obs:document.getElementById('aluno-obs').value.trim(),
          quitado:document.getElementById('aluno-quitado').checked,
          horario:null
        };
        if(!aluno.nome){ alert('Informe o nome completo.'); return; }
        const arr=loadAlunos(); arr.push(aluno); saveAlunos(arr);
        form.reset(); window.closeModal(); dedupeAlunos(); renderAll();
      });

      const modalEdit=document.getElementById('modal-edit');
      function openEditModal(id){
        renderProfs(); // atualiza lista de professores
        const a = loadAlunos().find(x=>String(x.id)===String(id));
        if(!a){ alert('Aluno não encontrado'); return; }
        document.getElementById('edit-id').value=a.id;
        document.getElementById('edit-nome').value=a.nome||'';
        document.getElementById('edit-cpf').value=a.cpf||'';
        document.getElementById('edit-email').value=a.email||'';
        document.getElementById('edit-contato').value=a.contato||'';
        document.getElementById('edit-idioma').value=a.idioma||'ingles';
        document.getElementById('edit-modalidade').value=a.modalidade||'turma';
        document.getElementById('edit-turma').value=a.turma||'';
        document.getElementById('edit-professor').value=a.professor||'';
        document.getElementById('edit-valor').value=a.valor||0;
        document.getElementById('edit-vencimento').value=a.vencimento||'';
        document.getElementById('edit-pagamento').value=a.pagamento||'Pix';
        document.getElementById('edit-status').value=a.status||'Ativo';
        document.getElementById('edit-obs').value=a.obs||'';
        document.getElementById('edit-quitado').checked=!!a.quitado;
        modalEdit.style.display='block';
      }
      function closeEditModal(){ modalEdit.style.display='none'; }
      window.closeEditModal=closeEditModal;
      document.getElementById('edit-form')?.addEventListener('submit',function(e){
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const arr = loadAlunos();
        const idx = arr.findIndex(a=>String(a.id)===String(id));
        if(idx===-1){ alert('Aluno não encontrado.'); return; }
        arr[idx] = {
          ...arr[idx],
          nome:document.getElementById('edit-nome').value.trim(),
          cpf:document.getElementById('edit-cpf').value.trim(),
          email:document.getElementById('edit-email').value.trim(),
          contato:document.getElementById('edit-contato').value.trim(),
          idioma:document.getElementById('edit-idioma').value,
          modalidade:document.getElementById('edit-modalidade').value,
          turma:document.getElementById('edit-turma').value.trim(),
          professor:document.getElementById('edit-professor').value,
          valor:parseFloat(document.getElementById('edit-valor').value||'0'),
          vencimento:document.getElementById('edit-vencimento').value,
          pagamento:document.getElementById('edit-pagamento').value,
          status:document.getElementById('edit-status').value,
          obs:document.getElementById('edit-obs').value.trim(),
          quitado:document.getElementById('edit-quitado').checked
        };
        saveAlunos(arr);
        closeEditModal();
        dedupeAlunos();
        renderAll();
      });

      // Delegação de eventos na tabela global: Editar / Remover
      tbodyGlobal.addEventListener('click', function(e){
        const btnEdit = e.target.closest('.edit-aluno');
        if(btnEdit){ e.preventDefault(); openEditModal(btnEdit.getAttribute('data-id')); return; }
        const btnRem = e.target.closest('.remove-aluno');
        if(btnRem){
          e.preventDefault();
          const id = btnRem.getAttribute('data-id');
          if(!confirm('Remover este aluno e TODAS as matrículas dele?')) return;
          const newAlunos = loadAlunos().filter(a => String(a.id)!==String(id));
          saveAlunos(newAlunos);
          const newMats = loadMatriculas().filter(m => String(m.alunoId)!==String(id));
          saveMatriculas(newMats);
          renderAll();
        }
      });

      /**********************
       * Import CSV pagamentos (Financeiro)
       **********************/
      document.getElementById('btnImportCSV')?.addEventListener('click', async ()=>{
        const f = document.getElementById('csvPayments').files[0];
        if(!f){ alert('Selecione um arquivo CSV.'); return; }
        const text = await f.text();
        const linhas = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        const pagos = [];
        const alunos = loadAlunos();
        for(const ln of linhas){
          const [email, valStr] = ln.split(',').map(s=>s?.trim());
          if(!email) continue;
          const a = alunos.find(x=> (x.email||'').toLowerCase() === email.toLowerCase());
          if(a){
            a.quitado = true;
            a.ultimoPagamentoValor = parseFloat(valStr||'0')||0;
            pagos.push(a.nome);
          }
        }
        saveAlunos(alunos);
        alert('Pagamentos importados para: '+ pagos.join('; '));
        renderAll();
      });
      document.getElementById('btnClearPaid')?.addEventListener('click', ()=>{
        if(!confirm('Limpar marcação de pago deste mês para todos?')) return;
        const alunos = loadAlunos().map(a=>({...a, quitado:false}));
        saveAlunos(alunos);
        renderAll();
      });

      /**********************
       * Relatório Financeiro
       **********************/
      const rfResumo = document.getElementById('rf-resumo');
      const rfDevedores = document.getElementById('rf-devedores');
      const rfDownload = document.getElementById('rf-download');

      document.getElementById('rf-gerar')?.addEventListener('click', ()=>{
        const mes = (document.getElementById('rf-mes').value||'').trim(); // opcional
        const alunos = loadAlunos();
        const ativos = alunos.filter(a=>a.status==='Ativo');
        const receber = ativos.reduce((s,a)=>s+(a.valor||0),0);
        const pago    = ativos.reduce((s,a)=>s+(a.quitado? (a.valor||0) : 0),0);
        const pend    = Math.max(0, receber - pago);

        rfResumo.innerHTML = `
          <div>Total de ativos: <strong>${ativos.length}</strong></div>
          <div>Total a receber: <strong>R$ ${receber.toLocaleString('pt-BR',{minimumFractionDigits:2})}</strong></div>
          <div>Total pago: <strong>R$ ${pago.toLocaleString('pt-BR',{minimumFractionDigits:2})}</strong></div>
          <div>Pendente: <strong class="text-amber-700">R$ ${pend.toLocaleString('pt-BR',{minimumFractionDigits:2})}</strong></div>
          ${mes? `<div class="text-xs text-gray-500 mt-1">Mês referência: ${mes}</div>`: '' }
        `;

        const devs = ativos.filter(a=>!a.quitado && (a.valor||0)>0);
        rfDevedores.innerHTML='';
        devs.forEach(a=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${a.nome}</td><td>${a.email||'-'}</td><td>${a.professor||'-'}</td><td>${(a.valor||0).toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>`;
          rfDevedores.appendChild(tr);
        });

        // CSV
        const rows = [
          ['Aluno','Email','Professor','Valor','StatusPago'],
          ...ativos.map(a=>[a.nome, a.email||'', a.professor||'', String(a.valor||0).replace('.',','), a.quitado?'Sim':'Não'])
        ];
        const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        rfDownload.href = url;
        rfDownload.classList.remove('hidden');
      });

      /**********************
       * Renderizações iniciais
       **********************/
      function renderAll(){ 
        renderDashboard(); 
        renderGlobal(); 
        renderByLanguage(); 
        renderMatriculas(); 
        renderProfs(); 
        renderPies();
      }
      dedupeAlunos(); // limpa ao carregar
      ensureLangPanels();
      setupLangTabClicks();
      renderAll();

      /**********************
       * Testes rápidos
       **********************/
      function test(name,fn){ try{fn(); return {name, ok:true};}catch(err){return{name,ok:false,err};} }
      const tests=[];
      tests.push(test('KPI ativos numérico',()=>{const n=parseInt(document.getElementById('kpialunos').textContent||'0'); if(isNaN(n)) throw new Error('KPI inválido');}));
      tests.push(test('Tabela global existe',()=>{ if(!document.getElementById('tbl-global')) throw new Error('tbl-global não existe'); }));
      tests.push(test('Tabs de idioma criadas',()=>{ ['panel-frances','panel-ingles','panel-espanhol','panel-italiano','panel-alema'].forEach(id=>{ if(!document.getElementById(id)) throw new Error('faltando '+id); }); }));
      const failed=tests.filter(t=>!t.ok);
      if(failed.length){
        const box=document.getElementById('test-results');
        box.classList.remove('hidden');
        box.innerHTML='<h3 class="font-semibold mb-2">Falhas nos testes</h3>'+failed.map(t=>`<div class="mb-1"><span class="font-medium">${t.name}:</span> ${t.err?.message||t.err}</div>`).join('');
        console.error('Testes falharam',failed);
      } else {
        console.info('Todos os testes passaram ✅');
      }
    });
  })();
  </script>
</body>
</html>
